<!DOCTYPE html>


<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Backgammon Board</title>
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
 <style>
     /* General Styles */
     body {
         font-family: Arial, sans-serif;
         margin: 0;
         padding: 0;
         display: flex;
         flex-direction: column;
         align-items: center;
         background-color: #4888b5;
     }


     .button-container {
         display: flex;
         gap: 20px;
         margin-bottom: 20px;
     }


     .mode-button.active {
         font-weight: bold;
         background-color: #bbb;
     }


     /* Board Layout */
     .board-container {
         display: flex;
         flex-direction: row;
         justify-content: space-between;
         width: 90%;
         aspect-ratio: 2 / 1;
         position: relative;
         border: 2px solid #4f1a1a;
         background-color: #fff;
     }




     .half-board {
         display: flex;
         flex-direction: column;
         width: 48%; /* Each half takes 48% of the width, leaving 4% for the bar */
     }








     .board-row {
         display: flex;
         justify-content: space-between;
         width: 100%;
         height: 50%; /* Adjust this height to make sure it's flush with the bottom */
         margin-bottom: 0; /* Remove the bottom margin between rows */
     }




     /* Bar in the middle */
     .bar {
         height: 100%;
         width: 4%;
         background-color: #4f1a1a;
         display: flex;
         justify-content: center;
         align-items: center;
         color: white;
         font-size: 18px;
         font-weight: bold;
     }




     /* Points and Placeholders */
     .point {
       display: flex;
       flex-direction: column;
       justify-content: center;
       align-items: center;
       width: 15%;
       height: 100%;
       border: 1px solid #333; /* Outline for each point */
       box-sizing: border-box;
       background-color: transparent;
       position: relative;
       font-size: 1.2rem; /* Adjust as necessary */
   }




     .placeholder {
       width: 70%;
       aspect-ratio: 1 / 1; /* Circular placeholders */
       border-radius: 50%;
       background-color: transparent; /* No fill color */
       border: 1px dashed transparent; /* No border, just for layout */
       cursor: pointer;
       margin: 2px 0; /* Adjust spacing */
       transition: background-color 0.3s;


     }




     .placeholder.white {
         background-color: white;
         border: 1px solid #333;
     }




     .placeholder.black {
         background-color: black;
         border: 1px solid #333;
     }
     .navbar {
         box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
     }


     .mb-4 {
         margin-bottom: 1.5rem; /* Spacing below the navbar */
     }


     .button-container {
         margin-top: 20px; /* Add spacing above the buttons */
         display: flex;
         gap: 20px;
         margin-bottom: 20px;
     }

     .moves-display {
         width: 90%;
         margin: 0 auto;
     }

     .move-item {
         border-bottom: 1px solid #eee;
         padding-bottom: 10px;
     }

     .move-item:last-child {
         border-bottom: none;
     }




 </style>
</head>
<body>
   <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4" style="width: 100%; padding: 0;">
       <a class="navbar-brand ml-3" href="#">Backgammon Analyzer</a>
       <div class="ml-auto d-flex">
           <a class="nav-link text-white" href="evaluate.html">Evaluate</a>
           <a class="nav-link text-white" href="instructions.html">Instructions</a>
       </div>
   </nav>


   <div>For guidance on how to use this webapp: <a href="instructions.html" style="color: red;">Click Here</a></div>




   <div class="button-container">
     <button class="btn btn-secondary" id="white-btn">White</button>
     <button class="btn btn-secondary" id="black-btn">Black</button>
     <button class="btn btn-secondary" id="delete-btn">Delete</button>
     <button class="btn btn-primary" id="best-move-btn">Get Best Move</button>
     <button class="btn btn-danger" id="clear-board-btn">Clear Board</button>
 </div>
 <div class="dice-input-container mb-4">
   <label for="dice-roll" class="h5">Dice Roll (e.g., 3,1):</label>
   <div class="input-group">
       <input type="text" id="dice-roll" class="form-control" placeholder="Enter dice roll" aria-label="Dice roll input">
       <div class="input-group-append">
   </div>
   </div>
</div>










 <div class="board-container">
     <!-- Left Half -->
     <div class="half-board">
         <!-- Top row of the left half -->
         <div class="board-row">
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
         </div>








         <!-- Bottom row of the left half -->
         <div class="board-row">
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
         </div>
     </div>








     <!-- Middle Bar -->
     <div class="bar"></div>








     <!-- Right Half -->
     <div class="half-board">
         <!-- Duplicate the same rows for the right half -->
         <div class="board-row">
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
         </div>








         <div class="board-row">
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
             <div class="point"><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div><div class="placeholder"></div></div>
         </div>
     </div>
 </div>

 <div class="moves-display mt-4">
     <h5>Best Moves:</h5>
     <div id="moves-list" class="p-3 border rounded bg-light">
         No moves calculated yet
     </div>
 </div>

       <script>
  // Mode tracking - keeps track of whether we're placing white pieces, black pieces, or deleting
  let currentMode = null;


// Get references to the mode control buttons
const whiteButton = document.getElementById('white-btn');
const blackButton = document.getElementById('black-btn');
const deleteButton = document.getElementById('delete-btn');
const clearBoardButton = document.getElementById('clear-board-btn');


// Get all placeholder elements that can contain checker pieces
const placeholders = document.querySelectorAll('.placeholder');


// Function to set the current interaction mode and update button styling
function setMode(mode) {
  currentMode = mode;


  // Remove active styling from all buttons first to ensure clean state
  [whiteButton, blackButton, deleteButton].forEach(button => {
      button.classList.remove('active');
  });


  // Add active styling to the selected mode button
  if (mode === 'white') whiteButton.classList.add('active');
  if (mode === 'black') blackButton.classList.add('active');
  if (mode === 'delete') deleteButton.classList.add('active');
}


// Add click handlers for the mode buttons
whiteButton.addEventListener('click', () => setMode('white'));
blackButton.addEventListener('click', () => setMode('black'));
deleteButton.addEventListener('click', () => setMode('delete'));

// Clear board handler - removes all pieces from the board
clearBoardButton.addEventListener('click', () => {
    placeholders.forEach(placeholder => {
        // Remove both white and black classes to clear the piece
        placeholder.classList.remove('white', 'black');
    });
});


// Add click handlers to each placeholder to handle piece placement/removal
placeholders.forEach(placeholder => {
  placeholder.addEventListener('click', () => {
      if (currentMode === 'white') {
          // Remove black first to ensure we don't have both classes
          placeholder.classList.remove('black');
          placeholder.classList.add('white');
      } else if (currentMode === 'black') {
          placeholder.classList.remove('white');
          placeholder.classList.add('black');
      } else if (currentMode === 'delete') {
          placeholder.classList.remove('white', 'black');
      }
  });
});


// Helper function to count total pieces of a color on the board
function countPieces(board) {
    // Sum up all piece counts in the board object using reduce
    return Object.values(board).reduce((sum, count) => sum + count, 0);
}

// Function to gather the current board state into a format the API expects
function getBoardState() {
    const points = document.querySelectorAll('.point');
    // o represents white pieces, x represents black pieces in API format
    const board = { o: {}, x: {} }; 

    // Define the point numbering order according to standard backgammon rules
    // Points are numbered 1-24, with white's home board being 1-6
    const pointOrder = [
        // Top row (left to right)
        13, 14, 15, 16, 17, 18,  // Black's outer board
        12, 11, 10, 9, 8, 7,    // Black's home board
        // Bottom row (left to right)
        19, 20, 21, 22, 23, 24, // White's outer board
        6, 5, 4, 3, 2, 1        // White's home board
    ];

    points.forEach((point, index) => {
        // Count white and black pieces at this point
        const whitePieces = point.querySelectorAll('.placeholder.white').length;
        const blackPieces = point.querySelectorAll('.placeholder.black').length;

        // Map visual board position to logical point number
        const pointNumber = pointOrder[index];
        // Only add to board state if pieces exist (keep it sparse)
        if (whitePieces > 0) board.o[pointNumber] = whitePieces;
        if (blackPieces > 0) board.x[pointNumber] = blackPieces;
    });

    // Validate that each player has exactly 15 pieces
    const whitePieceCount = countPieces(board.o);
    const blackPieceCount = countPieces(board.x);

    if (whitePieceCount !== 15) {
        throw new Error(`White must have exactly 15 pieces on the board (currently has ${whitePieceCount})`);
    }
    if (blackPieceCount !== 15) {
        throw new Error(`Black must have exactly 15 pieces on the board (currently has ${blackPieceCount})`);
    }

    return board;
}


// Helper function to check if a move is legal according to backgammon rules
function isLegalMove(from, to, board) {
    // In backgammon, you can't move to a point with 2+ opponent pieces (unless hitting a blot)
    const opponentPieces = board.x[to] || 0;
    if (opponentPieces >= 2) {
        return false;
    }
    return true;
}

// Function to fetch and process the best move from the API
async function getBestMove() {
    try {
        const boardState = getBoardState();
        const diceInput = document.getElementById("dice-roll").value;

        // Validate dice input format and values
        if (!diceInput.trim()) {
            throw new Error("Please enter a dice roll");
        }

        // Parse dice input - expects format like "3,4" or "3, 4"
        const dice = diceInput.split(",").map((d) => parseInt(d.trim(), 10));
        if (dice.length !== 2) {
            throw new Error("Please enter exactly two dice numbers separated by a comma");
        }
        if (dice.some((d) => isNaN(d) || d < 1 || d > 6)) {
            throw new Error("Dice values must be between 1 and 6");
        }

        // Prepare the API request payload with game rules and settings
        const payload = {
            board: boardState,
            cubeful: false, // Don't consider doubling cube
            dice: dice,
            "max-moves": 3, // Get top 3 moves
            player: "o", // White to play
            "score-moves": true, // Include evaluation scores
            rules: {
                allowIllegalMoves: false,
                requireExactUsage: true // Must use both dice
            }
        };

        // Make the API request
        const response = await fetch('http://localhost:8081/api/v1/getmoves', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'accept': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`API error: ${response.status} ${response.statusText}`);
        }

        const moves = await response.json();
        
        // Validate the API response format
        if (!moves || !Array.isArray(moves) || moves.length === 0) {
            throw new Error("No valid moves returned from the API");
        }

        // Ensure each move has the expected structure
        moves.forEach((move, index) => {
            if (!move.play || !Array.isArray(move.play)) {
                throw new Error(`Invalid move structure in move ${index + 1}`);
            }
        });

        displayBestMoves(moves);
    } catch (error) {
        alert(error.message);
        console.error("Error details:", error);
        return;
    }
}


// Function to display the calculated best moves in the UI
function displayBestMoves(moves) {
    const movesListDiv = document.getElementById('moves-list');
    
    // Filter out any illegal moves by checking each step of each move
    const legalMoves = moves.filter(move => {
        return move.play.every(step => {
            const boardState = getBoardState();
            return isLegalMove(step.from, step.to, boardState);
        });
    });

    if (legalMoves.length === 0) {
        movesListDiv.innerHTML = '<span class="text-danger">No legal moves available with these dice!</span>';
        alert("No legal moves available with these dice!");
        return;
    }

    // Build HTML for displaying the moves and their evaluations
    let movesHtml = '';
    legalMoves.forEach((move, index) => {
        // Create a section for each move
        movesHtml += `<div class="move-item mb-2">
            <strong>Move ${index + 1}:</strong><br>`;
        
        // Show each step of the move (e.g., "from point 8 to point 5")
        move.play.forEach(step => {
            movesHtml += `<span class="ml-3">• From ${step.from} to ${step.to}</span><br>`;
        });
        
        // Add evaluation data (winning chances, gammon chances, etc)
        const evalData = move.evaluation;
        movesHtml += `<span class="ml-3 text-muted">Evaluation:`;
        
        if (typeof evalData === 'object') {
            Object.entries(evalData).forEach(([key, value]) => {
                if (typeof value === 'object') {
                    // Handle nested evaluation data (like equity breakdowns)
                    movesHtml += `<br><span class="ml-4">- ${key}:`;
                    Object.entries(value).forEach(([subKey, subValue]) => {
                        movesHtml += `<br><span class="ml-5">• ${subKey}: ${subValue}</span>`;
                    });
                    movesHtml += '</span>';
                } else {
                    movesHtml += `<br><span class="ml-4">- ${key}: ${value}</span>`;
                }
            });
        } else {
            movesHtml += evalData;
        }
        movesHtml += `</span></div>`;

        // Visualize only the first (best) move on the board
        if (index === 0) {
            visualizeMove(move.play);
        }
    });

    movesListDiv.innerHTML = movesHtml;
}


// Function to highlight the moves visually on the board
function visualizeMove(play) {
  // Map point numbers to their corresponding DOM elements
  // This translates between the logical point numbers and the visual board
  const points = document.querySelectorAll('.point');
  const pointMap = {
      13: points[0], 14: points[1], 15: points[2], 16: points[3],
      17: points[4], 18: points[5], 12: points[6], 11: points[7],
      10: points[8], 9: points[9], 8: points[10], 7: points[11],
      19: points[12], 20: points[13], 21: points[14], 22: points[15],
      23: points[16], 24: points[17], 6: points[18], 5: points[19],
      4: points[20], 3: points[21], 2: points[22], 1: points[23]
  };


  // Highlight each move in the sequence
  play.forEach(step => {
      // Convert point numbers to DOM elements
      const fromPoint = pointMap[parseInt(step.from)];
      const toPoint = pointMap[parseInt(step.to)];


      // Add highlight borders - blue for source point, green for destination
      if (fromPoint) fromPoint.style.border = '2px solid blue';
      if (toPoint) toPoint.style.border = '2px solid green';


      // Remove highlights after 8 seconds to keep the board clean
      setTimeout(() => {
          if (fromPoint) fromPoint.style.border = '';
          if (toPoint) toPoint.style.border = '';
      }, 8000);
  });
}


// Add click handler for the "Get Best Move" button
document.getElementById('best-move-btn').addEventListener('click', getBestMove);
       </script>
       <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
       <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
       <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


   </body>
</html>